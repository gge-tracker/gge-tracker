<div class="player-stats-view position-relative">
  <div class="d-none d-md-block" *ngIf="!isInLoading">
    <div class="btn-exit right">
      <button class="btn btn-primary mt-3" (click)="addPlayerToFavorites()"
        *ngIf="!isInFavorites(); else notInFavorites">
        <i class="fas fa-star"></i>
        {{ 'Ajouter en favoris' | translate }}</button>
      <ng-template #notInFavorites>
        <button class="btn btn-primary mt-3" (click)="removePlayerFromFavorites()">
          <i class="fas fa-star"></i>
          {{ 'Retirer des favoris' | translate }}</button>
      </ng-template>
    </div>
  </div>
  <ng-container *ngIf="!isInLoading">
    <div class="player-stats-overlay"></div>
    <div class="position-relative player-stats-container">
      <div class="position-relative bg-castle d-flex flex-column justify-content-center"
        [ngClass]="{'d-none': !playerName}">
        <div class="mt-3 mx-auto position-relative" style="width: fit-content;">
          <img src="/assets/banner.png" class="img-fluid" [alt]="'Bannière' | translate">
          <span class="position-absolute top-50 start-50 translate-middle text-white fs-1" style="width: max-content">
            {{ playerName }}</span>
          <div id="allianceList">
            <a href="/castles?search={{ playerName }}" [title]="'Voir les châteaux' | translate">
              <img src="/assets/icon_castles.png" width="50" [alt]="'Paramètres' | translate" class="img-fluid mt-3">
            </a>
            <div class="d-inline-block alliance-more-info position-relative"
              [attr.data-updates]="allianceUpdates!.length-1">
              <img src="/assets/icon_alliance.png" width="50" [title]="'Voir l\'historique des alliances' | translate"
                class="img-fluid mt-3" alt="Alliance" data-bs-toggle="modal" data-bs-target="#allianceModal">
            </div>
            <div *ngIf="playerUpdates && playerUpdates.length > 1"
              class="d-inline-block alliance-more-info position-relative" [attr.data-updates]="playerUpdates!.length-1">
              <img src="/assets/icon_name.png" width="50"
                [title]="'Voir l\'historique des pseudonymes du joueur' | translate" class="img-fluid mt-3"
                [alt]="'Pseudonyme' | translate" data-bs-toggle="modal" data-bs-target="#playerModal">
            </div>
            <div *ngIf="stats && stats.peaceDisabledAt" class="d-inline-block alliance-more-info position-relative"
              [attr.data-updates]="peaceDisabledAtInDays">
              <img src="/assets/icon_peace.png" width="50"
                [title]="('Actuellement en protection Fin le' | translate) + ' ' + (stats.peaceDisabledAt | date: ('Date_1' | translate))"
                class="img-fluid mt-3" [alt]="'Protection' | translate">
            </div>
          </div>
        </div>
        <div class="container-fluid mt-3 leaderboard d-flex flex-wrap justify-content-around text-center">
          <div *ngFor="let event of events" class="card event-card m-2">
            <div *ngIf="getScoreboardFromEvent(event)" class="card-body d-flex flex-column justify-content-between">
              <h5 class="card-title"><img src="/assets/star.png" alt="Top 3"></h5>
              <div class="card-content d-flex align-items-center">
                <div class="img-container me-3">
                  <img [src]="'/assets/event-logo-id-' + event + '.png'" class="img-fluid" alt="Event" width="90"
                    height="90" [title]="getEventName(event)">
                </div>
                <div class="event-details">
                  <p class="card-text">
                    <span class="highlight-hours">{{ getScoreboardFromEvent(event) }}h</span>
                    &nbsp;{{ 'dans le top 3 du serveur' | translate }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="container-fluid mt-3" style="margin-bottom: 70px;" *ngIf="playerId && isBrowser">
        <div class="row g-3 mb-3 mt-1">
          <div class="col-6 col-md-4 col-xl">
            <div class="stat-card text-center">
              <div class="stat-icon">
                <img src="/assets/pp3.png" [alt]="'Points de puissance' | translate">
              </div>
              <div class="stat-title" *ngIf="stats">{{ 'Puissance' | translate }}</div>
              <div class="stat-value" *ngIf="stats; else spinnerRankignStats">{{ (animatedStats['mightCurrent'] || 0) |
                formatNumber }}</div>
            </div>
          </div>
          <div class="col-6 col-md-4 col-xl">
            <div class="stat-card text-center">
              <div class="stat-icon">
                <img src="/assets/honor2.png" [alt]="'Honneur' | translate">
              </div>
              <div class="stat-title" *ngIf="stats">{{ 'Honneur' | translate }}</div>
              <div class="stat-value" *ngIf="stats; else spinnerRankignStats">{{ animatedStats['honor'] }}</div>
            </div>
          </div>
          <div class="col-6 col-md-4 col-xl">
            <div class="stat-card text-center">
              <div class="stat-icon">
                <img src="/assets/ranking.png" [alt]="'Classement' | translate">
              </div>
              <div class="stat-title" *ngIf="stats">{{ 'Classement' | translate }} ({{ stats.server }})</div>
              <div class="stat-value" *ngIf="stats; else spinnerRankignStats">{{ (animatedStats['serverRank'] || 0) |
                formatNumber }}</div>
            </div>
          </div>
          <div class="col-6 col-md-4 col-xl">
            <div class="stat-card text-center">
              <div class="stat-icon">
                <img src="/assets/ranking.png" [alt]="'Classement mondial' | translate">
              </div>
              <div class="stat-title" *ngIf="stats">{{ 'Classement mondial' | translate }}</div>
              <div class="stat-value" *ngIf="stats; else spinnerRankignStats">{{ (animatedStats['globalRank'] || 0) |
                formatNumber }}</div>
            </div>
          </div>
          <div class="col-6 col-md-4 col-xl">
            <div class="stat-card text-center">
              <div class="stat-icon">
                <img src="/assets/lvl.png" [alt]="'Niveau' | translate">
              </div>
              <div class="stat-title" *ngIf="stats">{{ 'Niveau' | translate }}</div>
              <div class="stat-value" *ngIf="stats; else spinnerRankignStats">{{ (animatedStats['totalLevel'] || 0) |
                level }}</div>
            </div>
          </div>
          <div class="col-6 col-md-4 col-xl">
            <div class="stat-card text-center" data-bs-toggle="modal" data-bs-target="#patriarchModal">
              <div class="stat-icon">
                <img src="/assets/list-item.png" [alt]="'Nombre de chateaux' | translate">
              </div>
              <div class="stat-title" *ngIf="stats">{{ 'Nombre de chateaux' | translate }}</div>
              <div class="stat-value" *ngIf="stats; else spinnerRankignStats">{{ (animatedStats['totalCastles'] || 0) |
                formatNumber }}</div>
            </div>
          </div>
        </div>

        <div class="tabs-container">
          <button class="tab-button" *ngFor="let tab of tabs" (click)="updateTab(tab.key)"
            [ngClass]="{'active': currentTab === tab.key}">
            <img *ngIf="tab.assetIcon" [src]="'/assets/' + tab.assetIcon" width="24" height="24"
              [alt]="tab.label | translate">
            <span class="d-none d-lg-inline">&nbsp;{{ tab.label | translate }}</span>
          </button>
        </div>

        <div class="tab-content" *ngIf="currentTab === 'overview'">
          <div class="row">
            <div class="col-12 col-lg-6 mb-2">
              <app-player-stats-card [charts]="{ 'Graphique': charts['might'] }" *ngIf="charts['might']" [data]="[]"
                [title]="'Points de puissance' | translate" [dataName]="'Points de puissance' | translate"
                [backgroundIconImage]="'/assets/banner-pp.png'" [needSpecialLoader]="true"
                [eventName]="'player_might_history'" [isWeekly]="true" [playerId]="playerId"
                (updateData)="updateData($event)" [backgroundColour]="'rgb(255 230 35)'"></app-player-stats-card>
            </div>
            <div class="col-12 col-lg-6 mb-2">
              <app-player-stats-card [charts]="{ 'Graphique': charts['loot'] }" *ngIf="charts['loot']" [data]="[]"
                [title]="'Pillage hebdomadaire' | translate" [dataName]="'Points de pillage' | translate"
                [playerId]="playerId" [eventName]="'player_loot_history'" (updateData)="updateData($event)"
                [backgroundIconImage]="'/assets/banner-loot.png'"
                [backgroundColour]="'#e7a220'"></app-player-stats-card>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12 col-lg-6 mb-2">
              <app-player-stats-card [charts]="{ 'Graphique': charts['warRealms'] }" *ngIf="charts['warRealms']"
                [data]="[]" [title]="'Guerre des royaumes' | translate" [playerId]="playerId"
                [eventName]="'player_event_war_realms_history'" (updateData)="updateData($event)"
                [dataName]="'Points de guerre des royaumes' | translate"
                [backgroundIconImage]="'/assets/banner-realm.png'"
                [backgroundColour]="'rgb(216 182 255)'"></app-player-stats-card>
            </div>
            <div class="col-12 col-lg-6 mb-2">
              <app-player-stats-card [charts]="{ 'Graphique': charts['bloodcrow'] }" *ngIf="charts['bloodcrow']"
                [data]="[]" [title]="'Corbeaux de sang' | translate" [playerId]="playerId"
                [eventName]="'player_event_bloodcrow_history'" (updateData)="updateData($event)"
                [dataName]="'Points de corbeaux de sang' | translate"
                [backgroundIconImage]="'/assets/banner-bloodcrow.png'"
                [backgroundColour]="'rgb(216 182 255)'"></app-player-stats-card>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12 col-lg-6 mb-2">
              <app-player-stats-card [charts]="{ 'Graphique': charts['berimondKingdom'] }"
                *ngIf="charts['berimondKingdom']" [data]="[]" [title]="'Bataille de Berimond' | translate"
                [playerId]="playerId" [eventName]="'player_event_berimond_kingdom_history'"
                (updateData)="updateData($event)" [dataName]="'Points de Berimond' | translate"
                [backgroundIconImage]="'/assets/banner-berimond.png'"
                [backgroundColour]="'#00aaff'"></app-player-stats-card>
            </div>
            <div class="col-12 col-lg-6 mb-2">
              <app-player-stats-card #nomadChart [charts]="{ 'Graphique': charts['nomad'] }" *ngIf="charts['nomad']"
                [data]="[]" [title]="'Nomades' | translate" [dataName]="'Points de nomades' | translate"
                [playerId]="playerId" [eventName]="'player_event_nomad_history'" (updateData)="updateData($event)"
                [backgroundIconImage]="'/assets/banner-nomad.png'"
                [backgroundColour]="'rgb(255 130 54)'"></app-player-stats-card>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12 col-lg-6 mb-2">
              <app-player-stats-card #samuraiChart [charts]="{ 'Graphique': charts['samurai'] }"
                *ngIf="charts['samurai']" [data]="[]" [title]="'Samouraïs' | translate"
                [dataName]="'Points de samouraïs' | translate" [playerId]="playerId"
                [eventName]="'player_event_samurai_history'" (updateData)="updateData($event)"
                [backgroundIconImage]="'/assets/banner-samurai.png'"
                [backgroundColour]="'#58771db5'"></app-player-stats-card>
            </div>
          </div>
        </div>

        <div class="tab-content" *ngIf="currentTab === 'loot'">
          <div class="row">
            <div class="col-12">
              <app-player-stats-card [charts]="{ 'Graphique': charts['hourly-activity'] }"
                *ngIf="charts['hourly-activity']" [data]="[]" [title]="'Taux d\'activité par heure' | translate"
                [subtitle]="'Semaine précédente' | translate" [dataName]="'Taux d\'activité par heure' | translate"
                [playerId]="playerId" [eventName]="'player_loot_history'" (updateData)="updateData($event)"
                [backgroundIconImage]="'/assets/banner-loot.png'"
                [backgroundColour]="'#e7a220'"></app-player-stats-card>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12">
              <app-player-stats-card [charts]="{ 'Graphique': charts['avg-gain-hour'] }" *ngIf="charts['avg-gain-hour']"
                [data]="[]" [title]="'Gain moyen par heure' | translate" [subtitle]="'Semaine précédente' | translate"
                [dataName]="'Gain moyen par heure' | translate" [playerId]="playerId"
                [eventName]="'player_loot_history'" (updateData)="updateData($event)"
                [backgroundIconImage]="'/assets/banner-loot.png'"
                [backgroundColour]="'#e7a220'"></app-player-stats-card>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12">
              <app-player-stats-card [charts]="{ 'Graphique': charts['loot-heatmap'] }" *ngIf="charts['loot-heatmap']"
                [data]="[]" [title]="'Carte d\'activité hebdomadaire' | translate"
                [dataName]="'Carte d\'activité hebdomadaire' | translate" [playerId]="playerId"
                [eventName]="'player_loot_history'" (updateData)="updateData($event)"
                [backgroundIconImage]="'/assets/banner-loot.png'"
                [backgroundColour]="'#e7a220'"></app-player-stats-card>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12">
              <app-player-stats-card [charts]="{ 'Graphique': charts['loot'] }" *ngIf="charts['loot']" [data]="[]"
                [title]="'Pillage hebdomadaire' | translate" [dataName]="'Points de pillage' | translate"
                [playerId]="playerId" [eventName]="'player_loot_history'" (updateData)="updateData($event)"
                [backgroundIconImage]="'/assets/banner-loot.png'"
                [backgroundColour]="'#e7a220'"></app-player-stats-card>
            </div>
          </div>
        </div>

        <div class="tab-content" *ngIf="currentTab === 'alliances'">
          <div class="row">
            <div class="col-12 alliances-history-section">
              <ng-container *ngTemplateOutlet="allianceHistoryContent"></ng-container>
            </div>
          </div>
        </div>

        <div class="tab-content" *ngIf="currentTab === 'castles'">
          <div class="row mt-3">
            <div class="col-12 castles-overview-section">
              <ng-container *ngTemplateOutlet="patriarchOverviewContent"></ng-container>
            </div>
          </div>
        </div>

        <div class="tab-content" *ngIf="currentTab === 'glory' && currentPlayerTitle">
          <div class="tab-content" *ngIf="currentTab === 'glory' && currentPlayerTitle">
            <div class="fame-dashboard-modern">
              <div class="fame-hero-card mb-4">
                <div class="row g-0">
                  <div class="col-lg-7 p-4 position-relative z-1">
                    <div class="d-flex align-items-center mb-4">
                      <div class="fame-emblem-wrapper me-4">
                        <svg class="progress-ring position-absolute" width="80" height="80">
                          <circle class="progress-ring__circle" stroke="white" stroke-width="3" fill="transparent"
                            [ngStyle]="{ 'stroke-dashoffset': fameProgressStrokeOffset + 'px' }" r="36" cx="40"
                            cy="40" />
                        </svg>
                        <img src="/assets/glory.png" alt="Glory" class="fame-icon-lg">
                      </div>
                      <div>
                        <div class="text-uppercase text-gold-50 fs-7 ls-1 fw-bold mb-1">{{ 'Classement' | translate }}
                        </div>
                        <h1 class="display-6 fw-black text-white text-uppercase mb-0 text-shadow-glow">
                          {{ (currentTopXFameTitle ? (currentI18nTitleKey + currentTopXFameTitle.titleID) :
                          (currentI18nTitleKey + currentPlayerTitle.titleID)) | translate }}
                        </h1>
                        <div class="d-flex align-items-center mt-2 gap-3">
                          <span class="badge bg-dark-glass border-gold text-gold">
                            #{{ stats?.playerCurrentFameRank ?? 0 | formatNumber }}
                          </span>
                          <span class="text-white-50 fs-7">
                            <i class="bi bi-clock me-1"></i> {{ stats?.updatedAt | date:'shortTime' }}
                          </span>
                        </div>
                      </div>
                    </div>

                    <div class="fame-progress-wrapper mt-auto">
                      <div class="d-flex justify-content-between text-white mb-2 fs-6 fw-bold">
                        <span>
                          {{ stats?.currentFame ?? 0 | formatNumber }}
                          <span class="fw-normal">{{ 'Points de gloire' | translate }}</span>
                        </span>
                        <span>
                          {{ (nextFameTitle?.threshold ?? 0) | formatNumber }}
                          <span class="fw-normal" *ngIf="nextFameTitle">
                            ({{ (nextFameTitle ? (currentI18nTitleKey + nextFameTitle.titleID) : '-') | translate }})
                          </span>
                        </span>
                      </div>
                      <div class="progress-track">
                        <div class="progress-fill" [style.width.%]="fameProgressPercentage"></div>
                        <div class="decay-marker"
                          [style.left.%]="((((stats?.currentFame ?? 0) * (100 - (currentPlayerTitle.decay ?? 0))) / 100) / (nextFameTitle?.threshold ?? 1)) * 100"
                          [style.width.%]="fameProgressPercentage-(((((stats?.currentFame ?? 0) * (100 - (currentPlayerTitle.decay ?? 0))) / 100) / (nextFameTitle?.threshold ?? 1)) * 100)">
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-5 p-4 bg-gradient-dark border-start-glass d-flex flex-column justify-content-center">
                    <div class="decay-box">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-uppercase text-danger-light fs-7 fw-bold ls-1">
                          {{ 'Prévision journalière' | translate }}
                        </span>
                        <span class="badge bg-danger-subtle text-danger">{{ 'Perte de gloire' | translate: {'0':
                          currentPlayerTitle.decay} }}</span>
                      </div>
                      <div class="decay-stat-row mb-2">
                        <span class="label text-white-50">{{ 'Perte estimée' | translate }}</span>
                        <span class="value text-danger fw-bold">-{{ ((stats?.currentFame ?? 0) *
                          (currentPlayerTitle.decay ?? 0)) / 100 | formatNumber }}</span>
                      </div>
                      <div class="decay-stat-row big-stat">
                        <span class="label text-white-50">{{ 'Points de gloire' | translate }}</span>
                        <span class="value text-white">
                          {{ ((stats?.currentFame ?? 0) * (100 - (currentPlayerTitle.decay ?? 0))) / 100 | formatNumber }}
                        </span>
                      </div>
                      <div class="alert-mini mt-3" [ngClass]="{
                        'alert-safe': (((stats?.currentFame ?? 0) * (100 - (currentPlayerTitle.decay ?? 0))) / 100) >= (currentPlayerTitle.threshold ?? 0),
                        'alert-risk': (((stats?.currentFame ?? 0) * (100 - (currentPlayerTitle.decay ?? 0))) / 100) < (currentPlayerTitle.threshold ?? 0)
                      }">
                        <span
                          *ngIf="(((stats?.currentFame ?? 0) * (100 - (currentPlayerTitle.decay ?? 0))) / 100) >= (currentPlayerTitle.threshold ?? 0)">
                          <i class="bi bi-shield-check me-2"></i> {{ 'Titre sécurisé' | translate }}
                        </span>
                        <span
                          *ngIf="(((stats?.currentFame ?? 0) * (100 - (currentPlayerTitle.decay ?? 0))) / 100) < (currentPlayerTitle.threshold ?? 0)">
                          <i class="bi bi-exclamation-triangle-fill me-2"></i>
                          {{ 'Attention : Risque de rétrogradation' | translate }}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="section-header mb-3">
                <h3 class="h5 text-white fw-bold"><span class="text-gold">★</span> {{ 'Titres de gloire' | translate }}
                </h3>
              </div>

              <div class="row g-3 mb-5">
                <div *ngFor="let fameTitle of fameTitlesTopX" class="col-lg-3 col-sm-6 col-12">
                  <div class="prestige-card"
                    [class.active]="(stats?.playerCurrentFameRank ?? 0) <= (fameTitle.topX ?? -1)">
                    <div class="prestige-rank">#{{ fameTitle.topX }}</div>
                    <div class="prestige-name">{{ currentI18nTitleKey + fameTitle.titleID | translate }}</div>
                    <div class="prestige-req">{{ fameTitle.threshold ?? -1 | formatNumber }} pts</div>
                    <div class="glow-effect"></div>
                  </div>
                </div>
              </div>

              <div class="fame-ladder">
                <div *ngFor="let fameTitle of fameTitles" class="ladder-item" [ngClass]="{
                    'status-secured': (((stats?.currentFame ?? 0) * (100 - (currentPlayerTitle.decay ?? 0))) / 100) >= (fameTitle.threshold ?? 0),
                    'status-danger': (stats?.currentFame ?? 0) >= (fameTitle.threshold ?? 0) && (((stats?.currentFame ?? 0) * (100 - (currentPlayerTitle.decay ?? 0))) / 100) < (fameTitle.threshold ?? 0),
                    'status-locked': (stats?.currentFame ?? 0) < (fameTitle.threshold ?? -1)
                  }">
                  <div class="status-strip"></div>

                  <div class="ladder-content">
                    <div class="ladder-info">
                      <span class="ladder-threshold">{{ (fameTitle?.threshold ?? -1) | formatNumber }}</span>
                      <span class="ladder-name">{{ currentI18nTitleKey + fameTitle.titleID | translate }}</span>
                    </div>

                    <div class="ladder-state-icon">
                      <ng-container *ngIf="(stats?.currentFame ?? 0) < (fameTitle.threshold ?? -1)">
                        <span class="icon-lock"><i class="bi bi-lock-fill"></i></span>
                      </ng-container>

                      <ng-container *ngIf="(stats?.currentFame ?? 0) >= (fameTitle.threshold ?? 0)">
                        <span class="icon-check"
                          *ngIf="(((stats?.currentFame ?? 0) * (100 - (currentPlayerTitle.decay ?? 0))) / 100) >= (fameTitle.threshold ?? 0)">
                          <i class="bi bi-check-circle-fill"></i>
                        </span>
                        <span class="icon-warning"
                          *ngIf="(((stats?.currentFame ?? 0) * (100 - (currentPlayerTitle.decay ?? 0))) / 100) < (fameTitle.threshold ?? 0)">
                          <i class="bi bi-exclamation-triangle-fill"></i>
                        </span>
                      </ng-container>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>


<div class="modal fade" id="playerModal" tabindex="-1" aria-labelledby="playerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="playerModalLabel" translate>Historique des changements de pseudonymes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          [attr.aria-label]="'Fermer' | translate"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th scope="col">
                  <img src="/assets/date.png" class="img-fluid" [alt]="'Date' | translate">
                  {{ 'Date' | translate }}
                </th>
                <th scope="col">
                  <img src="/assets/gge-logo.png" class="img-fluid" [alt]="'Pseudonyme' | translate">
                  {{ 'Pseudonyme' | translate }}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let player of playerUpdates">
                <td>{{ player.date ? ((player.date | date: 'dd/MM/yyyy HH') + 'h') : ('Pseudonyme initial' | translate)
                  }}</td>
                <td>{{ player.player }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="allianceModal" tabindex="-1" aria-labelledby="allianceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="allianceModalLabel" translate>Historique des changements d'alliances</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          [attr.aria-label]="'Fermer' | translate"></button>
      </div>
      <div class="modal-body">
        <ng-container *ngTemplateOutlet="allianceHistoryContent"></ng-container>
      </div>
    </div>
  </div>
</div>

<ng-template #allianceHistoryContent>
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th scope="col">
            <img src="/assets/date.png" class="img-fluid" alt="Date">
            {{ 'Date' | translate }}
          </th>
          <th scope="col">
            <img src="/assets/alliance.png" class="img-fluid" alt="Alliance">
            {{ 'Alliance' | translate }}
          </th>
          <th scope="col">
            <img src="/assets/time.png" class="img-fluid" alt="Durée">
            {{ 'Durée' | translate }}
          </th>
          <th scope="col">
            {{ 'Actions' | translate }}
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let alliance of allianceUpdates">
          <td>{{ alliance.date ? ((alliance.date | date: 'dd/MM/yyyy HH') + 'h') : ('Alliance initiale' |
            translate) }}</td>
          <td [ngClass]="{'text-muted': !alliance.alliance}">{{ alliance.alliance ?? ('Sans alliance' | translate)
            }}</td>
          <td>{{ alliance.duration }}</td>
          <td *ngIf="alliance.alliance; else noAlliance">
            <div class="btn-group">
              <a class="gge-btn search btn-sm" data-bs-dismiss="modal" [routerLink]="['/', 'players']"
                [queryParams]="{'alliance': alliance.alliance}" [title]="'Voir les membres de l\'alliance' | translate">
                <i class="fas fa-eye"></i>
                <span class="d-none d-lg-inline">&nbsp;{{ 'Voir les membres' | translate }}</span>
              </a>
              <a class="gge-btn search btn-sm" data-bs-dismiss="modal" [routerLink]="['/', 'map', alliance.id]"
                [title]="'Voir l\'alliance sur la carte' | translate">
                <img src="/assets/map.png" width="16" class="img-fluid" [alt]="'Voir sur la carte' | translate">
                <span class="d-none d-lg-inline">&nbsp;{{ 'Voir sur la carte' | translate }}</span>
              </a>
            </div>
          </td>
          <ng-template #noAlliance>
            <td>
              <span class="text-muted"><em>
                  {{ 'Aucune action' | translate }}
                </em></span>
            </td>
          </ng-template>
        </tr>
      </tbody>
    </table>
  </div>
</ng-template>

<div class="modal fade" id="patriarchModal" tabindex="-1" aria-labelledby="patriarchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="patriarchModalLabel">{{ 'Vue d\'ensemble de l\'alliance' | translate }} ({{
          quantity.patriarch }})
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          [attr.aria-label]="'Fermer' | translate"></button>
      </div>
      <div class="modal-body">
        <ng-container *ngTemplateOutlet="patriarchOverviewContent"></ng-container>
      </div>
    </div>
  </div>
</div>

<ng-template #patriarchOverviewContent>
  <div class="d-flex row justify-content-between monuments-quantity text-center align-items-end assets-overview">
    <div class="col">
      <img src="/assets/castle1.png" [alt]="'Chateau principal' | translate" [title]="'Chateau principal' | translate">
      <br>
      <span>{{ quantity.castle }}</span>
    </div>
    <div class="col">
      <img src="/assets/castle4.png" [alt]="'Avant-poste' | translate" [title]="'Avant-poste' | translate">
      <br>
      <span>{{ quantity.outpost }}</span>
    </div>
    <div class="col">
      <img src="/assets/monument.png" [alt]="'Monument' | translate" [title]="'Monument' | translate">
      <br>
      <span>{{ quantity.monument }}</span>
    </div>
    <div class="col">
      <img src="/assets/labo.png" [alt]="'Laboratoire' | translate" [title]="'Laboratoire' | translate">
      <br>
      <span>{{ quantity.laboratory }}</span>
    </div>
    <div class="col">
      <img src="/assets/tour-royale.png" [alt]="'Tour royale' | translate" [title]="'Tour royale' | translate">
      <br>
      <span>{{ quantity.royalTower }}</span>
    </div>
    <div class="col">
      <img src="/assets/capitale.png" [alt]="'Capitale' | translate" [title]="'Capitale' | translate">
      <br>
      <span>{{ quantity.capital }}</span>
    </div>
    <div class="col">
      <img src="/assets/cite-marchande.png" [alt]="'Cité marchande' | translate" [title]="'Cité marchande' | translate">
      <br>
      <span>{{ quantity.city }}</span>
    </div>
  </div>
  <div class="table-wrapper rounded-3">
    <div class="d-flex align-items-center mb-3 px-2 pt-2">
      <i class="fa-solid fa-magnifying-glass me-2 text-muted"></i>
      <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()"
        placeholder="{{ 'Rechercher' | translate }}..." class="form-control search-input flex-grow-1" />
    </div>
    <div class="table-responsive">
      <table class="modern-table w-100">
        <thead>
          <tr>
            <th (click)="sortBy('type')">
              {{ 'Type de patrimoine' | translate }}
              <i *ngIf="sortColumn === 'type'" class="ms-1 fa-solid" [class.fa-arrow-up]="sortAsc"
                [class.fa-arrow-down]="!sortAsc"></i>
            </th>
            <th (click)="sortBy('kingdom')">
              {{ 'Royaume' | translate }}
              <i *ngIf="sortColumn === 'kingdom'" class="ms-1 fa-solid" [class.fa-arrow-up]="sortAsc"
                [class.fa-arrow-down]="!sortAsc"></i>
            </th>
            <th (click)="sortBy('position')">
              {{ 'Position' | translate }}
              <i *ngIf="sortColumn === 'position'" class="ms-1 fa-solid" [class.fa-arrow-up]="sortAsc"
                [class.fa-arrow-down]="!sortAsc"></i>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let monument of paginatedMonuments">
            <td>{{ monument.type }}</td>
            <td class="kid-{{ monument.kingdom }}">{{ getRealmName(monument.kingdom) | translate}}</td>
            <td>{{ monument.position }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination-modern d-flex justify-content-center align-items-center mt-3 gap-2">
      <button class="btn btn-light btn-sm rounded-circle shadow-sm" (click)="changePage(-1)"
        [disabled]="currentPage <= 1">
        <i class="fa-solid fa-chevron-left"></i>
      </button>
      <span class="page-indicator">{{ currentPage }} / {{ totalPages }}</span>
      <button class="btn btn-light btn-sm rounded-circle shadow-sm" (click)="changePage(1)"
        [disabled]="currentPage >= totalPages">
        <i class="fa-solid fa-chevron-right"></i>
      </button>
    </div>
  </div>
</ng-template>

<ng-template #spinnerRankignStats>
  <div class="text-center spinner-container">
    <i class="fas fa-spinner fa-spin"></i>
  </div>
</ng-template>
